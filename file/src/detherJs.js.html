<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/detherJs.js | detherjs</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Dether SDK to easily call smart contract from Javascript"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="detherjs"><meta property="twitter:description" content="Dether SDK to easily call smart contract from Javascript"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/dethertech/dether.js"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/detherJs.js~DetherJS.html">DetherJS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/detherUser.js~DetherUser.html">DetherUser</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#constants">constants</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-COORD_PRECISION">COORD_PRECISION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GAS_PRICE">GAS_PRICE</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add0x">add0x</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAddr">isAddr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createMnemonic">createMnemonic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decryptMnemonic">decryptMnemonic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encryptMnemonic">encryptMnemonic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Contracts">Contracts</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/detherJs.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Ethers from &apos;ethers&apos;;


import { add0x, isAddr } from &apos;./utils/eth&apos;;
import DetherUser from &apos;./detherUser&apos;;
import Contracts from &apos;./utils/contracts&apos;;
import Providers from &apos;./utils/providers&apos;;
import Formatters from &apos;./utils/formatters&apos;;
// to add different stuff on it
import {createMnemonic, encryptMnemonic, decryptMnemonic} from &apos;./utils/mnemonic&apos;;


/**
 * @example
 * import DetherJS from &apos;dether.js&apos;;
 */
class DetherJS {
  /**
   * Creates an instance of DetherUser
   * You may not instanciate from here, prefer from DetherJS.getUser method
   *
   * @param {object}    providerData
   * @param {String}    providerData.network      Name of network (&apos;homestead&apos;,
   *                                              &apos;ropsten&apos;, &apos;rinkeby&apos;, &apos;kovan&apos;)
   * @param {?String}   providerData.rpcURL       JSON RPC provider URL
   * @param {?String}   providerData.infuraKey    INFURA API Key
   * @param {?String}   providerData.etherscanKey Etherscan API Key
   */
  constructor(providerData) {
    /** @ignore */
    this.provider = Providers.getProvider(providerData);
    /** @ignore */
    this.contractInstance = Contracts.getDetherContract(this.provider);
    /** @ignore */
    this.storageInstance = Contracts.getDetherStorageContract(this.provider);

    if (!this.contractInstance || !this.storageInstance) throw new Error(&apos;Unable to load contracts&apos;);
  }

  /**
   * Get instance of DetherUser linked to this Dether instance
   * @param  {object}  encryptedWallet Encrypted user wallet
   * @return {Object} DetherUser
   */
  getUser(encryptedWallet) {
    return new DetherUser({
      encryptedWallet,
      dether: this,
    });
  }

  /**
   * get teller by address
   * @param  {string}  address ethereum address
   * @return {Promise&lt;Object&gt;} teller
   */
  async getTeller(address) {
    const [rawTellerPos, rawTellerProfile1, rawTellerProfile2] = await Promise.all([
      this.storageInstance.getTellerPositionRaw(address),
      this.storageInstance.getTellerProfile1(address),
      this.storageInstance.getTellerProfile2(address),
    ]);
    // if (Ethers.utils.formatEther(rawTellerPos[3]) === &apos;0.0&apos;) return null;

    return Object.assign(
      {},
      Formatters.tellerPosFromContract(rawTellerPos),
      Formatters.tellerProfileFromContract1(rawTellerProfile1),
      Formatters.tellerProfileFromContract2(rawTellerProfile2),
      {
        id: address,
        ethAddress: address,
      },
    );
  }

  /**
   * @ignore
   * Filter null and removes tellers with same address
   * @param {Array} list tellers
   * @return {Array} filtered tellers
   */
  static _filterTellerList(list) {
    return list
      .filter(teller =&gt; !!teller)
      .reduce(
        (acc, teller) =&gt;
          (!acc.some(t =&gt; t.ethAddress === teller.ethAddress) ? [...acc, teller] : acc),
        [],
      );
  }

  /**
   * Get All tellers on the map
   * @param  {array}   addr ethereum addresses
   * @return {Promise&lt;Array&gt;} array of tellers
   */
  async getAllTellers(addrs) {
    if (addrs &amp;&amp; !Array.isArray(addrs)) throw new TypeError(&apos;Need array of addresses as parameter&apos;);
    const result = addrs ? [addrs] : await this.storageInstance.getAllTellers();

    if (!result || !result.length || !Array.isArray(result[0])) return [];

    const tellerAddrList = result[0];

    const tellers = await Promise.all(tellerAddrList.map(this.getTeller.bind(this)));
    return DetherJS._filterTellerList(tellers);
  }

  /**
   * Get All tellers per zone
   * @param  {string}  countryId
   * @param  {Integer}  postalCode
   * @return {Promise&lt;Array&gt;} array of tellers in zone
   */
  async getTellersInZone(countryId, postalCode) {
    if (!Number.isInteger(postalCode) ) throw new TypeError(&apos;Invalid zone&apos;);
    const result = [];

      const tellersInZone = await this.storageInstance.getZone(countryId, postalCode);
    if (!tellersInZone) return [];
    const tellersList = tellersInZone[0];
    const tellers = await Promise.all(tellersList.map(this.getTeller.bind(this)));
    return tellers;
    // return DetherJS._filterTellerList(tellers);
  }

  /**
   * Get teller balance in escrow
   * @param  {string} address  Teller ethereum address
   * @return {Promise&lt;Number&gt;} Escrow balance of teller at address
   */
  async getTellerBalance(address) {
    if (!isAddr(address)) throw new TypeError(&apos;Invalid ETH address&apos;);

    const fullAddress = add0x(address);
    const result = await this.contractInstance.getTellerBalance(fullAddress);

    return Number(Ethers.utils.formatEther(result[0]));
  }

}

DetherJS.Ethers = Ethers;
DetherJS.createMnemonic = createMnemonic;
DetherJS.encryptMnemonic = encryptMnemonic;
DetherJS.decryptMnemonic = decryptMnemonic;

export default DetherJS;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
